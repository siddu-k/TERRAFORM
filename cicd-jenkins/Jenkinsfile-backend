pipeline {
    agent any
    
    environment {
        APP_DIR = '/var/www/flask-app'
        VENV_DIR = '/var/www/flask-app/venv'
        REPO_URL = 'https://github.com/siddu-k/Docker_compose_assignment.git'
    }
    
    stages {
        stage('Cleanup') {
            steps {
                sh 'rm -rf backend-temp'
            }
        }
        
        stage('Checkout') {
            steps {
                sh 'git clone ${REPO_URL} backend-temp'
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh '''
                    cd backend-temp/backend
                    python3 -m venv ${VENV_DIR}
                    . ${VENV_DIR}/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }
        
        stage('Copy Files') {
            steps {
                sh '''
                    sudo cp -r backend-temp/backend/* ${APP_DIR}/
                    sudo chown -R jenkins:jenkins ${APP_DIR}
                '''
            }
        }
        
        stage('Configure Service') {
            steps {
                sh '''
                    sudo tee /etc/systemd/system/flask-backend.service > /dev/null <<EOF
[Unit]
Description=Flask Backend
After=network.target

[Service]
Type=simple
User=jenkins
WorkingDirectory=${APP_DIR}
Environment="PATH=${VENV_DIR}/bin"
ExecStart=${VENV_DIR}/bin/python3 app.py
Restart=always

[Install]
WantedBy=multi-user.target
EOF
                '''
            }
        }
        
        stage('Deploy') {
            steps {
                sh '''
                    sudo systemctl daemon-reload
                    sudo systemctl enable flask-backend
                    sudo systemctl restart flask-backend
                    sleep 5
                    sudo systemctl status flask-backend
                '''
            }
        }
        
        stage('Cleanup Temp') {
            steps {
                sh 'rm -rf backend-temp'
            }
        }
    }
    
    post {
        success {
            echo 'Flask backend deployed successfully'
        }
        failure {
            echo 'Deployment failed'
        }
    }
}
